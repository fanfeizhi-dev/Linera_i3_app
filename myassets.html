<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Assets - Intelligence Cubed</title>
    <link rel="icon" type="image/svg+xml" href="/svg/I3 logo.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="/png/i3-token-logo.png">  
    <link rel="apple-touch-icon" sizes="192x192" href="/png/i3-token-logo.png"> 
    <link rel="preload" as="image" href="/svg/chains/ethereum.svg">
    <link rel="preload" as="image" href="/svg/chains/bnb.svg">
    <link rel="preload" as="image" href="/svg/chains/polygon-zkevm.svg">
    <link rel="preload" as="image" href="/svg/chains/arbitrum.svg">
    <link rel="preload" as="image" href="/svg/chains/optimism.svg">
    <link rel="preload" as="image" href="/svg/chains/solana.svg">
    <link rel="preload" as="image" href="/svg/chains/base.svg">
    <link rel="preload" as="image" href="/svg/chains/zksync.svg">
    <link rel="preload" as="image" href="/svg/chains/opbnb.svg"> 
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="myassets.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- Base Account SDK -->
    <script src="https://unpkg.com/@base-org/account/dist/base-account.min.js"></script>
    
    <script>
        // ç®€å•çš„åˆå§‹åŒ–
        window.cdpConnect = async function() {
            if (!window.createBaseAccountSDK) {
                throw new Error('Base Account SDK not loaded');
            }
            
            const provider = window.createBaseAccountSDK({
                appName: 'Intelligence Cubed',
                appLogoUrl: 'https://intelligencecubed.netlify.app/png/i3-token-logo.png'
            }).getProvider();
            
            // ç›´æ¥è¯·æ±‚è´¦æˆ·è¿æ¥ï¼Œè·³è¿‡å¤æ‚çš„èº«ä»½éªŒè¯æµç¨‹
            const accounts = await provider.request({
                method: 'eth_requestAccounts'
            });
            
            if (accounts && accounts.length > 0) {
                return { address: accounts[0] };
            }
            
            throw new Error('No accounts returned');
        };

    </script>

    <!-- ä»…åœ¨æ—§æµè§ˆå™¨éœ€è¦ï¼›ç°ä»£æµè§ˆå™¨ä¹Ÿå¯ä»¥ä¿ç•™ï¼Œä¸ä¼šæœ‰å‰¯ä½œç”¨ -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js"></script>

        <script>
      window.appkit = null;
      window.dispatchEvent(new Event('reownAppKitLoaded'));
      console.log('[AppKit] disabled: Phantom-only mode');
    </script>

    <script type="module-shim">
	  import {
	    Connection,
	    clusterApiUrl,
	    PublicKey
	  } from 'https://esm.sh/@solana/web3.js@1.95.3';
	  window.SOL = { Connection, clusterApiUrl, PublicKey };
	</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
		.wallet-modal {
		  display: flex !important;            /* å§‹ç»ˆ flex å¸ƒå±€ */
		  align-items: center !important;      /* å§‹ç»ˆå‚ç›´å±…ä¸­ */
		  justify-content: center !important;  /* å§‹ç»ˆæ°´å¹³å±…ä¸­ */
		  position: fixed !important;
		  inset: 0 !important;
		  z-index: 10000;
		  background: rgba(0,0,0,.4);          /* âœ… æ­£ç¡®å†™æ³• */
		  opacity: 0;
		  transition: opacity .25s ease;
		  pointer-events: none;                /* å…³é—­æ—¶ä¸å¯ç‚¹å‡» */
		}
		.wallet-modal.show {
		  opacity: 1;
		  pointer-events: auto;                /* æ‰“å¼€æ—¶å¯ç‚¹å‡» */
		}
		.wallet-modal-content {
		  position: relative;
		  background: #fff;
		  border-radius: 24px;
		  padding: 36px;
		  max-width: 440px;
		  width: 92%;
		  max-height: 80vh;
		  overflow-y: auto;
		  box-shadow: 0 12px 40px rgba(0,0,0,.12); /* âœ… æ­£ç¡®å†™æ³• */
		  transform: scale(.95);
		  opacity: 0;
		  transition: transform .25s ease, opacity .25s ease;
		}
		.wallet-modal.show .wallet-modal-content {
		  transform: scale(1);
		  opacity: 1;
		}

        /* ç§»é™¤å¯èƒ½å¯¼è‡´é—®é¢˜çš„åŠ¨ç”» */
        @keyframes modalSlideIn {
            to { transform: none !important; }
        }

        .wallet-modal-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .wallet-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            font-family: 'Inter', sans-serif;
        }

        .wallet-modal-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 400;
            line-height: 1.5;
        }

        .wallet-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f3f4f6;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .wallet-close-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        /* é’±åŒ…é€‰é¡¹å¡ç‰‡ */
        /* æ›´ç´§å‡‘çš„å¡ç‰‡ä¸è¡Œè· */
		.wallet-option {
		  display: flex;
		  align-items: center;
          justify-content: center;
		  gap: 12px;
		  padding: 12px 14px;          /* åŸ 20px -> æ›´ç´§å‡‘ */
		  border: 1px solid #e5e7eb;
		  border-radius: 8px;          /* åŸ 16px/24px -> 8px */
		  background: #fff;
		  transition: background .2s ease, border-color .2s ease, transform .2s ease;
		}
		.wallet-option:hover {
		  border-color: #d1d5db;
		  background: #f9fafb;         /* å»æ‰å¤§é¢ç§¯æ¸å˜ */
		  transform: translateY(-1px);
		}
		/* åˆ—è¡¨é¡¹é—´è·æ›´ç´§å‡‘ */
		.wallet-options { 
		  display: flex; 
		  flex-direction: column; 
		  gap: 12px;                   /* åŸ 16px -> 12px */
		}

		/* é’±åŒ…æ–‡å­—ä¿¡æ¯ */
		/* æ ‡é¢˜æ–‡å­—ï¼šæ²‰ç¨³ã€å·¦å¯¹é½ï¼Œä¸æ¼‚æµ® */
		.wallet-name {
		  font-size: 14px;
		  font-weight: 500;
		  color: #111827;
		  line-height: 1;

		}
		/* å‰¯æ ‡é¢˜ï¼ˆå¦‚æœä½¿ç”¨ï¼‰å¼±åŒ–æ˜¾ç¤ºï¼ŒåŒæ ·å·¦é½ */
		.wallet-description {
		  font-size: 12px;
		  color: #6b7280;
		  line-height: 1.2;
		}
		/* çŠ¶æ€ä¸ç®­å¤´ */
		.wallet-status.status-available { background: rgba(16,185,129,.1); color:#059669; }
        .wallet-icon-wrap{
		  width:24px;
		  height:24px;
		  display:flex;
		  align-items:center;
		  justify-content:center;
		  flex-shrink:0;            /* é˜²æ­¢æŒ¤å‹ */
		}
		/* æ”¾ <img> çš„æƒ…å†µ */
		.wallet-icon-wrap img{
		  width:100%;
		  height:100%;
		  object-fit:contain;       /* ç­‰æ¯”ä¸å˜å½¢ */
		  display:block;
		}
		/* æ”¾ <svg> ç›´æ’çš„æƒ…å†µ */
		.wallet-icon-wrap svg{
		  width:24px;
		  height:24px;
		  display:block;
		}

        /* Account æŒ‰é’®å³ä¾§çš„å°å›¾æ ‡ */
		#walletTypeIcon {
		  width: 18px;
		  height: 18px;
		  margin-left: 8px;
		  vertical-align: middle;
		  display: none;        /* é»˜è®¤éšè—ï¼Œè¿æ¥åå†æ˜¾ç¤º */
		  object-fit: contain;  /* é˜²æ­¢å˜å½¢ */
		}

        .wallet-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #6b7280;    /* ç°è‰²ï¼Œä½è°ƒä¸€ç‚¹ */
            font-weight: 400;
        }


        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .wallet-modal-content {
                padding: 24px;
                margin: 20px;
                width: calc(100% - 40px);
            }

            .wallet-modal-title {
                font-size: 1.25rem;
            }

            .wallet-name {
                font-size: 1rem;
            }
        }

/* Network modal (ç‹¬ç«‹äº wallet modal) */
		.network-modal {
		  position: fixed;
		  inset: 0;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  background: rgba(17, 24, 39, 0.6);
		  backdrop-filter: blur(2px);
		  opacity: 0;
		  pointer-events: none;
		  transition: opacity .25s ease;
		  z-index: 9999;
		}
		.network-modal.show {
		  opacity: 1;
		  pointer-events: auto;
		}
		.network-modal-content {
		  width: min(420px, 92vw);
		  background: #fff;
		  border-radius: 12px;                  /* åœ†è§’æ›´å°ï¼Œæ›´ç´§å‡‘ */
		  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
		  padding: 24px 24px 20px;
		  transform: scale(.95);
		  opacity: 0;
		  transition: transform .25s ease, opacity .25s ease;
		}
		.network-modal.show .network-modal-content {
		  transform: scale(1);
		  opacity: 1;
		}
		.network-modal-header {
		  display: flex;
		  align-items: center;
		  justify-content: space-between;
		  margin-bottom: 24px;
		}
		.network-modal-title {
		  font-size: 18px;
		  font-weight: 600;
		  color: #1f2937;
		}
		.network-modal-subtitle {
		  font-size: 13px;
		  color: #6b7280;
		  margin-top: 4px;
		}
		.network-close-btn {
		  border: none;
		  background: transparent;
		  font-size: 18px;
		  line-height: 1;
		  cursor: pointer;
		  color: #6b7280;
		  transition: color .2s ease;
		}
		.network-close-btn:hover {
		  color: #111827;
		}
		.network-modal-footer {
		  text-align: center;
		  margin-top: 16px;
		  font-size: 13px;
		  color: #6b7280;
		}
		/* å¼¹çª—é‡Œçš„æŒ‰é’®æ ·å¼ï¼šæ›´ç´§å‡‘ï¼Œè§„æ•´ */
		.network-modal-content .wallet-option {
		  display: flex;
		  align-items: center;       /* å›¾æ ‡ + æ–‡å­—å‚ç›´å±…ä¸­ */
		  justify-content: flex-start;
		  gap: 12px;
		  padding: 12px 14px;        /* ç´§å‡‘å†…è¾¹è· */
		  border: 1px solid #e5e7eb;
		  border-radius: 8px;        /* å°åœ†è§’ */
		  background: #fff;
		  transition: background .2s ease, border-color .2s ease, transform .2s ease;
		}
		.network-modal-content .wallet-option:hover {
		  border-color: #d1d5db;
		  background: #f9fafb;       /* ç®€å•æµ…ç° hover */
		  transform: translateY(-1px);
		}
		.network-modal-content .wallet-name {
		  font-size: 14px;
		  font-weight: 500;
		  color: #111827;
		}
		.network-modal-content .wallet-description {
		  font-size: 12px;
		  color: #6b7280;
		}

        /* --- Current Network badge --- */
		.network-badge{
		  display:inline-flex; align-items:center; gap:8px;
		  background:#f3f4f6; color:#1f2937;
		  border:1px solid #e5e7eb; border-radius:999px;
		  padding:6px 12px; margin-right:12px;
		  height:34px; line-height:1; white-space:nowrap;
		}
		.network-badge__icon{ width:20px; height:20px; object-fit:contain; display:block }
		.network-badge__text{ font-size:14px; font-weight:600; letter-spacing:.2px }
		.network-badge__caret{ width:16px; height:16px; opacity:.6 }
		@media (max-width: 768px){
		  .network-badge{ display:none !important; }
		}

        /* Token logo styling */
        .token-logo {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 4px;
        }
    
        .token-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 4px;
        }
        
        /* Follow X Modal */
        .follow-x-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .follow-x-modal.show {
            display: flex;
            opacity: 1;
        }

        .follow-x-modal-content {
            position: relative;
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            transition: transform 0.25s ease;
        }

        .follow-x-modal.show .follow-x-modal-content {
            transform: scale(1);
        }

        .follow-x-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #f3f4f6;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 18px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .follow-x-close:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .follow-x-modal-header {
            text-align: center;
            margin-bottom: 28px;
        }

        .follow-x-modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .follow-x-modal-subtitle {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
        }

        .follow-x-input-group {
            margin-bottom: 20px;
        }

        .follow-x-input-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .follow-x-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .follow-x-input {
            flex: 1;
            padding: 12px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            color: #111827;
            transition: all 0.2s ease;
        }

        /* è¾“å…¥æ¡†èšç„¦çš„é«˜å…‰ä¹Ÿä»ç»¿è‰²æ”¹ä¸ºå“ç‰Œç´« */
        .follow-x-input:focus {
          outline: none;
          border-color: #8b5cf6;
          box-shadow: 0 0 0 3px rgba(139,92,246,.15);
        }

        .follow-x-input:readonly {
            background: #f9fafb;
            color: #6b7280;
        }

        /* Follow å¼¹çª— - æ‰“å¼€ X çš„æŒ‰é’®ä¹Ÿç”¨å“ç‰Œç´« */
        .follow-x-button {
          padding: 12px 20px;
          background: linear-gradient(135deg,#8b5cf6,#7c3aed);
          color: #fff;
          border: none;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 700;
          cursor: pointer;
          transition: all .2s ease;
          white-space: nowrap;
        }

        .follow-x-button:hover {
          transform: translateY(-1px);
          box-shadow: 0 6px 16px rgba(124,58,237,.32);
        }

        /* å¼¹çª—åº•éƒ¨ Confirm æŒ‰é’®ç»Ÿä¸€ä¸ºå“ç‰Œç´« */
        .confirm-button {
          width: 100%;
          padding: 14px;
          background: linear-gradient(135deg,#8b5cf6,#7c3aed);
          color: #fff;
          border: none;
          border-radius: 10px;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
          transition: all .2s ease;
          margin-top: 8px;
        }
        .confirm-button:hover {
          transform: translateY(-1px);
          box-shadow: 0 6px 16px rgba(124,58,237,.32);
        }

        .confirm-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .status-message {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
        }

        .status-message.pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        @media (max-width: 480px) {
            .follow-x-modal-content {
                padding: 24px;
                width: 95%;
            }
            
            .follow-x-input-wrapper {
                flex-direction: column;
                gap: 8px;
            }
            
            .follow-x-button {
                width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="account-dropdown.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <!-- Left Section -->
            <div class="header-left">
                <div class="logo" onclick="window.location.href='index.html'" style="cursor: pointer;">
                    <img src="svg/I3 logo.svg" alt="Intelligence Cubed" class="logo-image">
                </div>
                <nav class="nav-menu">
                    <button class="nav-item" onclick="window.location.href='index.html'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        Chats
                    </button>
                    <button class="nav-item" onclick="window.location.href='modelverse.html'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L2 7l10 5 10-5-10-5z" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="m2 17 10 5 10-5" stroke="currentColor" stroke-width="2"/>
                            <path d="m2 12 10 5 10-5" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Modelverse
                    </button>
                    <button class="nav-item" onclick="window.location.href='benchmark.html'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        Benchmark
                    </button>
                    <button class="nav-item" onclick="window.location.href='canvas.html'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M9 9h6v6H9z" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        Canvas
                    </button>
                    <button class="nav-item" onclick="window.location.href='workflow.html'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        Workflows
                    </button>
                    <button class="nav-item" onclick="window.location.href='mycart.html'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M7 4V2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M5 4h14l-1 14H6L5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        MyCart
                    </button>
                </nav>
            </div>

            <!-- Right Section -->
			<div class="header-right">
                <button id="networkBadge" class="network-badge" type="button" style="display:none" onclick="openNetworkPickerModal()">
				  <img class="network-badge__icon" src="" alt="">
				  <span class="network-badge__text">Network</span>
			        <svg class="network-badge__caret" width="12" height="12" viewBox="0 0 24 24">
				        <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2"/>
				    </svg>
				</button>
			  <div class="user-section">
			    <div id="accountDropdownMount"></div>
			  </div>
			</div>
        </div>
    </header>

                <!-- Right Section -->
            <div class="header-right">
                <!-- Current Network badge (shows only after wallet connected) -->
                <button id="networkBadge" class="network-badge" type="button" style="display:none" onclick="openNetworkPickerModal()">
				  <img class="network-badge__icon" src="" alt="">
				  <span class="network-badge__text">Network</span>
			        <svg class="network-badge__caret" width="12" height="12" viewBox="0 0 24 24">
				        <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2"/>
				    </svg>
				</button>
                <div id="networkPickerMount"></div>
                <div class="user-section">
                    <div id="accountDropdownMount"></div>
                </div>
            </div>
        </div>
    </header>


    <script>
	(function syncRenderNetworkBadge(){
	  try {
	    // 1) è¯»å–æœ¬åœ°"é¦–é€‰ç½‘ç»œ"ï¼ˆä½ å·²æœ‰ getPreferredNetworkï¼‰
	    var pref = (window.getPreferredNetwork && window.getPreferredNetwork()) || null;
	    // 2) å¿«é€Ÿæ˜ å°„ï¼ˆä»…ç”¨äºé¦–å±ï¼Œä¸ä¾èµ–ä»»ä½• SDKï¼‰
	    var ICON = {
	      ethereum: '/svg/chains/ethereum.svg',
	      bnb:      '/svg/chains/bnb.svg',
	      polygon:  '/svg/chains/polygon-zkevm.svg',
	      arbitrum: '/svg/chains/arbitrum.svg',
	      optimism: '/svg/chains/optimism.svg',
	      solana:   '/svg/chains/solana.svg',
          opbnb:   '/svg/chains/opbnb.svg',
          zksync:   '/svg/chains/zksync.svg',
          base:   '/svg/chains/base.svg',   
	    };
	    var NAME = {
	      ethereum: 'Ethereum',
	      bnb:      'BNB Chain',
	      polygon:  'Polygon',
	      arbitrum: 'Arbitrum',
	      optimism: 'Optimism',
	      solana:   'Solana',
          opbnb:   'opBNB',
          zksync:   'Zksync',
          base:   'Base',
	    };
	    // 3) æ‰¾åˆ°å¾½ç« èŠ‚ç‚¹ï¼ˆä½ æŒ‰é’®é‡Œå·²æœ‰è¿™äº› idï¼‰
	    var badge  = document.getElementById('networkBadge');
	    var iconEl = document.getElementById('networkBadgeIcon');
	    var textEl = document.getElementById('networkBadgeText');
	    if (!badge || !iconEl || !textEl) return;
	    // 4) è®¡ç®—é¦–å± keyï¼šSolana ç›´æ¥æ˜¾ç¤º solanaï¼Œå…¶å®ƒé»˜è®¤ ethereum
	    var key  = (pref && pref.key)  || 'ethereum';
	    var kind = (pref && pref.kind) || 'evm';
	    if (kind === 'solana') key = 'solana';
	    // 5) åŒæ­¥æ¸²æŸ“ï¼Œä¸ç­‰ SDK
	    iconEl.src = ICON[key] || ICON.ethereum;
	    iconEl.alt = NAME[key] || 'Network';
	    textEl.textContent = NAME[key] || 'Network';
	    badge.style.display = 'inline-flex';
	    badge.style.visibility = 'visible'; // è§£é™¤åˆå§‹éšè—
	  } catch (e) {
	    // é™é»˜å¤±è´¥ï¼Œé¿å…é˜»å¡é¦–å±
	  }
	})();
	</script>

    <!-- Main Content -->
    <main class="main-content">
        <div class="assets-container">
            <!-- Page Header -->
            <div class="page-header">
                <div class="header-content">
                    <div class="title-section">
                        <h1 class="page-title">My Assets</h1>
                        <p class="page-subtitle">Manage your model tokens and shares portfolio</p>
                    </div>
                    <button class="clear-all-btn" onclick="clearAllAssets()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Clear All (Test)
                    </button>
                </div>
            </div>

            <!-- Assets Overview -->
            <div class="assets-overview">
                <div class="overview-card">
                    <div class="card-icon tokens-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3>Total Tokens</h3>
                        <p class="card-value" id="totalTokenValue">0.00 <img src="svg/usdc.svg" class="token-logo" alt="USDC" style="width: 16px; height: 16px; vertical-align: middle;"></p>
                        <p class="card-change positive" id="totalTokenChange">+0.00%</p>
                    </div>
                </div>

                <div class="overview-card">
                    <div class="card-icon shares-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3>Total Share Value</h3>
                        <p class="card-value" id="totalShareValue">0.00 <img src="svg/usdc.svg" class="token-logo" alt="USDC" style="width: 16px; height: 16px; vertical-align: middle;"></p>
                        <p class="card-change negative" id="totalShareChange">+0.00%</p>
                    </div>
                </div>

            </div>

            <!-- Tabs -->
            <div class="assets-tabs">
                <button class="tab-btn active" onclick="showTab('tokens')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6"/>
                    </svg>
                    My Model Tokens
                </button>
                <button class="tab-btn" onclick="showTab('shares')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                    </svg>
                    My Model Shares
                </button>
                <button class="tab-btn" onclick="showTab('workflows')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    </svg>
                    My Workflows
                </button>
            </div>

            <!-- My Model Tokens Tab -->
            <div class="tab-content active" id="tokensTab">
                <div class="section-header">
                    <h2>My Model Tokens</h2>
                    <p class="section-subtitle">Track your token usage and remaining capacity</p>
                </div>

                <div class="empty-state" id="emptyTokens" style="display: none;">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6"/>
                        </svg>
                    </div>
                    <h3>No Model Tokens Yet</h3>
                    <p>Purchase some model tokens from the <a href="modelverse.html">Modelverse</a> to get started!</p>
                </div>

                <div class="assets-table-container" id="tokensTable">
                    <table class="assets-table">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Category</th>
                                <th>Number of API Calls</th>
                                <th>Total Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tokensTableBody">
                            <!-- Token rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- My Model Shares Tab -->
            <div class="tab-content" id="sharesTab">
                <div class="section-header">
                    <h2>My Model Shares</h2>
                    <p class="section-subtitle">Monitor your share investments and market performance</p>
                </div>

                <div class="empty-state" id="emptyShares" style="display: none;">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                        </svg>
                    </div>
                    <h3>No Model Shares Yet</h3>
                    <p>Invest in some model shares from the <a href="modelverse.html">Modelverse</a> to start earning!</p>
                </div>

                <div class="assets-table-container" id="sharesTable">
                    <table class="assets-table">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Category</th>
                                <th>Shares Owned</th>
                                <th>Current Price</th>
                                <th>Market Change</th>
                                <th>Pool Ownership</th>
                                <th>Total Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sharesTableBody">
                            <!-- Share rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- My Workflows Tab -->
            <div class="tab-content" id="workflowsTab">
                <div class="section-header">
                    <h2>My Workflows</h2>
                    <p class="section-subtitle">Manage your private workflow designs and automations</p>
                </div>

                <div class="empty-state" id="emptyWorkflows" style="display: none;">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                    </div>
                    <h3>No Private Workflows Yet</h3>
                    <p>Create and save your custom workflows from the <a href="canvas.html">Canvas</a> to access them here!</p>
                </div>

                <div class="assets-table-container" id="workflowsTable">
                    <table class="assets-table">
                        <thead>
                            <tr>
                                <th>Workflow Name</th>
                                <th>Models Used</th>
                                <th>Created Date</th>
                                <th>Last Modified</th>
                                <th>Status</th>
                                <th>Privacy</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="workflowsTableBody">
                            <!-- Workflow rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>       
    </main>

    <script src="contract-config.js"></script>
    <script src="config.js"></script>
    <script src="api-manager.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="pricing.js"></script>
    <script src="/mcp-client.js"></script>
    <script src="model-data.js"></script>
    <script src="myassets.js"></script>
    <script src="wallet-manager.js"></script>
	<script src="wallet-integration.js"></script>
	<script src="account-dropdown.js"></script>  
    <script type="module" src="chains.js"></script>
    <script type="module" src="solana-wallet.js"></script>
    <script type="module" src="solana-checkin.js"></script>
 
    <script src="onchain-checkin.js"></script>
    <!-- Follow X Modal -->
    <div id="followXModal" class="follow-x-modal">
        <div class="follow-x-modal-content">
            <button class="follow-x-close" onclick="closeFollowXModal()">âœ•</button>
            
            <div class="follow-x-modal-header">
                <h2 class="follow-x-modal-title">Follow the Team</h2>
                <p class="follow-x-modal-subtitle">
                    Follow @I3_Cubed on X (Twitter) and enter your Twitter handle to complete the task.
                </p>
            </div>

            <div class="follow-x-input-group">
                <label>1. Follow our X account</label>
                <div class="follow-x-input-wrapper">
                    <input type="text" class="follow-x-input" value="I3_Cubed" readonly>
                    <button class="follow-x-button" onclick="openTwitterProfile()">
                        Follow
                    </button>
                </div>
            </div>

            <div class="follow-x-input-group">
                <label>2. Enter your Twitter handle</label>
                <div class="follow-x-input-wrapper">
                    <input type="text" 
                           id="twitterHandleInput" 
                           class="follow-x-input" 
                           placeholder="@YourTwitterHandle">
                </div>
            </div>

            <button class="confirm-button" onclick="confirmFollowX()">
                Confirm
            </button>

            <div id="followXStatus" class="status-message" style="display: none;"></div>
        </div>
    </div>
    <script src="social-tasks.js"></script>

</body>
</html>     <script>
      document.addEventListener('DOMContentLoaded', function(){
        try { injectAccountDropdown('#accountDropdownMount'); } catch (e) { console.warn('injectAccountDropdown failed:', e); }
      });
    </script>

    <!-- Google è®¤è¯åŠŸèƒ½ - ç›´æ¥å†…è”å®ç° -->
    <script>
        // Firebase é…ç½® - è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCYdWqXjUfNbUAMWlcm8neZQGTBTA63pfM",
            authDomain: "i3-testnet.firebaseapp.com",
            projectId: "i3-testnet",
            storageBucket: "i3-testnet.firebasestorage.app",
            messagingSenderId: "892139814159",
            appId: "1:892139814159:web:4df8548eef1d9bd9a1927a",
            measurementId: "G-KCDG3D1FCC"
        };


        // é…ç½®éªŒè¯å‡½æ•°
        function validateFirebaseConfig() {
            const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
            const missingFields = requiredFields.filter(field => !firebaseConfig[field] || firebaseConfig[field] === '');
            
            if (missingFields.length > 0) {
                console.error('âŒ Firebase é…ç½®ç¼ºå°‘å­—æ®µ:', missingFields);
                return false;
            }
            
            // æ£€æŸ¥ API Key æ ¼å¼
            if (!firebaseConfig.apiKey.startsWith('AIzaSy') || firebaseConfig.apiKey.length < 30) {
                console.error('âŒ Firebase API Key æ ¼å¼ä¸æ­£ç¡®');
                return false;
            }
            
            console.log('âœ… Firebase é…ç½®éªŒè¯é€šè¿‡');
            return true;
        }

        // å…¨å±€å˜é‡
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        let currentUser = null;

        // åˆå§‹åŒ– Firebase - ä¿®å¤æ—¶åºé—®é¢˜
        async function initializeFirebase() {
            try {
                // é¦–å…ˆéªŒè¯é…ç½®
                if (!validateFirebaseConfig()) {
                    throw new Error('Firebase é…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ä¿¡æ¯');
                }
                
                console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ– Firebase...');
                
                // åŠ¨æ€åŠ è½½ Firebase SDK
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
                const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
                const { getFirestore, initializeFirestore, doc, setDoc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
                
                // åˆå§‹åŒ–åº”ç”¨
                firebaseApp = initializeApp(firebaseConfig);
                firebaseAuth = getAuth(firebaseApp);
                // Connect to the named Firestore database for this project
                try {
                    firebaseDb = initializeFirestore(firebaseApp, {}, 'i3-testnet');
                } catch (e) {
                    console.warn('initializeFirestore failed, falling back to default database:', e);
                    firebaseDb = getFirestore(firebaseApp);
                }
                // æš´éœ²åˆ°å…¨å±€ä»¥ä¾¿å…¶ä»–è„šæœ¬è®¿é—®
                window.firebaseApp = firebaseApp;
                window.firebaseAuth = firebaseAuth;
                window.firebaseDb = firebaseDb;
                // è®°å½•å·²è¿æ¥çš„ Firestore æ•°æ®åº“åç§°
                try {
                    const proj = (firebaseDb && firebaseDb._databaseId && firebaseDb._databaseId.projectId) || firebaseConfig.projectId;
                    const dbId = (firebaseDb && firebaseDb._databaseId && firebaseDb._databaseId.database) || '(default)';
                    console.log('âœ… Firestore ready:', { projectId: proj, databaseId: dbId });
                } catch (_) {}
                
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šæš´éœ²åˆ° window,æ–¹ä¾¿å…¶ä»–è„šæœ¬ & Console è°ƒè¯•
                Object.assign(window, { firebaseApp, firebaseAuth, firebaseDb });
                
                // Notify listeners that Firebase is ready
                try { window.dispatchEvent(new Event('firebaseReady')); } catch (_) {}
                
                console.log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
                
                // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨
                onAuthStateChanged(firebaseAuth, async (user) => {
                    if (user) {
                        console.log('ç”¨æˆ·å·²ç™»å½•:', user.email);
                        currentUser = user;
                        // ğŸ”‘ è®©å…¶ä»–é€»è¾‘è¯†åˆ«å·²ç™»å½•
                        window.currentUser = user;
                        // è®°å½•ç™»å½•æ—¶é—´ä¸æ¬¡æ•°
                        try {
                            await upsertUserLogin(user);
                            console.log('ğŸ•’ Google login at (client):', new Date().toISOString());
                        } catch (e) { console.warn('è®°å½•ç™»å½•æ—¶é—´å¤±è´¥(å¯å¿½ç•¥):', e); }
                        // è‹¥é’±åŒ…å·²è¿æ¥ï¼Œè‡ªåŠ¨å°†é’±åŒ…ä¿å­˜åˆ° users/<uid>
                        try {
                            if (window.walletManager && window.walletManager.isConnected && window.walletManager.walletAddress) {
                                const address = window.walletManager.walletAddress;
                                if (window.ethereum && typeof window.ethereum.request === 'function') {
                                    window.ethereum.request({ method: 'eth_chainId' }).then((cid) => {
                                        if (typeof window.onWalletConnected === 'function') window.onWalletConnected(address, cid);
                                    }).catch(() => {
                                        if (typeof window.onWalletConnected === 'function') window.onWalletConnected(address);
                                    });
                                } else if (typeof window.onWalletConnected === 'function') {
                                    window.onWalletConnected(address);
                                }
                            }
                        } catch (linkErr) {
                            console.warn('è‡ªåŠ¨é“¾æ¥é’±åŒ…åˆ°ç”¨æˆ·å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', linkErr);
                        }
                        updateUIForSignedInUser(user);
                        loadUserData(user.uid);
                    } else {
                        console.log('ç”¨æˆ·å·²é€€å‡º');
                        currentUser = null;
                        window.currentUser = null; // å¯é€‰
                        updateUIForSignedOutUser();
                    }
                });
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆå…ƒç´ å¯èƒ½ä¸å­˜åœ¨ï¼Œåšé˜²å¾¡æ€§åˆ¤æ–­ï¼‰
                (function(){
                    const el = document.getElementById('googleSignInStatus');
                })();
                
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šFirebase åˆå§‹åŒ–æˆåŠŸåï¼Œé‡æ–°ç»‘å®šç™»å½•æŒ‰é’®äº‹ä»¶å¹¶å¯ç”¨æŒ‰é’®
                bindGoogleSignInEvent();
                
                // å¯ç”¨ç™»å½•æŒ‰é’®ï¼ˆå…ƒç´ å¯èƒ½ä¸å­˜åœ¨ï¼‰
                (function(){
                    const googleSignInBtn = document.getElementById('googleSignInBtn');
                    if (googleSignInBtn) {
                        googleSignInBtn.disabled = false;
                        googleSignInBtn.style.opacity = '1';
                        googleSignInBtn.style.cursor = 'pointer';
                        console.log('âœ… Google ç™»å½•æŒ‰é’®å·²å¯ç”¨');
                    }
                })();
                
            } catch (error) {
                console.error('âŒ Firebase åˆå§‹åŒ–å¤±è´¥:', error);
                const el = document.getElementById('googleSignInStatus');
                if (el) el.textContent = 'Firebase åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
            }
        }

        // Google ç™»å½•å¤„ç†å‡½æ•° - å®‰å…¨ç‰ˆæœ¬
        async function handleGoogleSignIn(mode) {
            try {
                // åŒé‡æ£€æŸ¥ï¼šç¡®ä¿ Firebase å·²åˆå§‹åŒ–
                if (!firebaseAuth || !firebaseApp) {
                    console.error('âŒ Firebase æœªåˆå§‹åŒ–');
                    alert('Firebase è¿˜æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                    return;
                }
                
                (function(){
                    const el = document.getElementById('googleSignInStatus');
                    if (el) el.textContent = 'Logging in...';
                })();
                
                const { GoogleAuthProvider, signInWithPopup, signInWithRedirect } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
                const provider = new GoogleAuthProvider();
                // å¼ºåˆ¶æ¯æ¬¡ç™»å½•æ—¶éƒ½è¦æ±‚ç”¨æˆ·é‡æ–°é€‰æ‹©è´¦æˆ·æˆ–è¾“å…¥å¯†ç 
                provider.setCustomParameters({
                    prompt: 'login'
                });
                
                // å½“ç”±é’±åŒ…è¿æ¥è‡ªåŠ¨è§¦å‘æ—¶ï¼Œä¼˜å…ˆå°è¯•å¼¹çª—ï¼Œè‹¥è¢«æ‹¦æˆªåˆ™å›é€€åˆ°é‡å®šå‘
                if (mode === 'auto') {
                    try {
                        const result = await signInWithPopup(firebaseAuth, provider);
                        console.log('âœ… ç™»å½•æˆåŠŸ:', result.user.email);
                        (function(){
                            const el = document.getElementById('googleSignInStatus');
                            if (el) el.textContent = 'Log in successfulï¼';
                        })();
                    } catch (popupErr) {
                        const code = popupErr && popupErr.code;
                        if (code === 'auth/popup-blocked' || code === 'auth/cancelled-popup-request') {
                            console.warn('Popup blocked or cancelled; falling back to redirect login');
                            await signInWithRedirect(firebaseAuth, provider);
                            // é¡µé¢å°†è·³è½¬è¿›è¡Œç™»å½•
                            return;
                        }
                        throw popupErr;
                    }
                } else {
                    const result = await signInWithPopup(firebaseAuth, provider);
                    console.log('âœ… ç™»å½•æˆåŠŸ:', result.user.email);
                    (function(){
                        const el = document.getElementById('googleSignInStatus');
                        if (el) el.textContent = 'Log in successfulï¼';
                    })();
                }
                
            } catch (error) {
                console.error('âŒ Log in failed:', error);
                if (error.code === 'auth/unauthorized-domain') {
                    const el = document.getElementById('googleSignInStatus');
                    if (el) el.textContent = 'åŸŸåæœªæˆæƒï¼Œè¯·åœ¨ Firebase æ§åˆ¶å°æ·»åŠ å½“å‰åŸŸå';
                } else {
                    const el = document.getElementById('googleSignInStatus');
                    if (el) el.textContent = 'Log in failed: ' + error.message;
                }
            }
        }

        // Expose sign-in function globally so other scripts can invoke it
        window.handleGoogleSignIn = handleGoogleSignIn;

        // ğŸ”‘ å…³é”®ä¿®å¤ï¼šå®‰å…¨çš„æŒ‰é’®äº‹ä»¶ç»‘å®šå‡½æ•°
        function bindGoogleSignInEvent() {
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            if (googleSignInBtn) {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                googleSignInBtn.replaceWith(googleSignInBtn.cloneNode(true));
                
                // è·å–æ–°çš„æŒ‰é’®å¼•ç”¨
                const newBtn = document.getElementById('googleSignInBtn');
                
                // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
                newBtn.addEventListener('click', handleGoogleSignIn);
                
                console.log('âœ… Google ç™»å½•æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }
        }

        // æ›´æ–°å·²ç™»å½•ç”¨æˆ·çš„ UI
        function updateUIForSignedInUser(user) {
            // éšè— Google ç™»å½•æŒ‰é’®ï¼ˆå…ƒç´ å¯èƒ½ä¸å­˜åœ¨ï¼‰
            (function(){
                const btn = document.getElementById('googleSignInBtn');
                if (btn) btn.style.display = 'none';
                const status = document.getElementById('googleSignInStatus');
                if (status) status.textContent = `Already Logged in: ${user.email}`;
            })();
            
            // ä¿æŒé’±åŒ…è¿æ¥éƒ¨åˆ†å¯è§ï¼ˆå…ƒç´ å¯èƒ½ä¸å­˜åœ¨ï¼‰
            (function(){
                const ws = document.getElementById('walletSection');
                if (ws) ws.style.display = 'block';
            })();
            
            // æ›´æ–°è´¦æˆ·æŒ‰é’®æ–‡æœ¬
            const accountBtnText = document.getElementById('accountBtnText');
            if (accountBtnText) {
                accountBtnText.textContent = user.displayName || user.email;
            }
            
            // æ˜¾ç¤º logout æŒ‰é’®
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.style.display = 'block';
            }
            
            console.log('âœ… ç”¨æˆ·å·²ç™»å½•ï¼Œé’±åŒ…åŠŸèƒ½ä¿æŒå¯è§ï¼Œlogout æŒ‰é’®å·²æ¿€æ´»');
        }

        // æ›´æ–°æœªç™»å½•ç”¨æˆ·çš„ UI
        function updateUIForSignedOutUser() {
            // æ˜¾ç¤º Google ç™»å½•æŒ‰é’®ï¼ˆå…ƒç´ å¯èƒ½ä¸å­˜åœ¨ï¼‰
            (function(){
                const btn = document.getElementById('googleSignInBtn');
                if (btn) btn.style.display = 'flex';
                const status = document.getElementById('googleSignInStatus');
            })();
            
            // ä¿æŒé’±åŒ…è¿æ¥éƒ¨åˆ†å¯è§ï¼ˆå…ƒç´ å¯èƒ½ä¸å­˜åœ¨ï¼‰
            (function(){
                const ws = document.getElementById('walletSection');
                if (ws) ws.style.display = 'block';
            })();
            
            // æ¢å¤è´¦æˆ·æŒ‰é’®æ–‡æœ¬
            const accountBtnText = document.getElementById('accountBtnText');
            if (accountBtnText) {
                accountBtnText.textContent = 'Login';
            }
            
            // éšè— logout æŒ‰é’®
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
            }
            
            console.log('âŒ ç”¨æˆ·å·²é€€å‡ºï¼Œé’±åŒ…åŠŸèƒ½ä¿æŒå¯è§ï¼Œlogout æŒ‰é’®å·²éšè—');
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData(uid) {
            try {
                if (!firebaseDb) return;
                
                const { doc, getDoc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
                const userRef = doc(firebaseDb, 'users', uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    console.log('ç”¨æˆ·æ•°æ®å·²å­˜åœ¨');
                } else {
                    // åˆ›å»ºæ–°ç”¨æˆ·æ–‡æ¡£
                    const userData = {
                        uid: uid,
                        email: currentUser.email,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL,
                        lastLogin: new Date(),
                        createdAt: new Date(),
                        isActive: true
                    };
                    
                    await setDoc(userRef, userData);
                    console.log('âœ… æ–°ç”¨æˆ·æ–‡æ¡£å·²åˆ›å»º');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }

        // ç¡®ä¿ç”¨æˆ·æ–‡æ¡£å­˜åœ¨å¹¶è®°å½•æœ¬æ¬¡ç™»å½•æ—¶é—´
        async function upsertUserLogin(user) {
            try {
                if (!firebaseDb || !user || !user.uid) return;
                const { doc, getDoc, setDoc, updateDoc, serverTimestamp, increment } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
                const userRef = doc(firebaseDb, 'users', user.uid);
                const snap = await getDoc(userRef);
                if (!snap.exists()) {
                    await setDoc(userRef, {
                        uid: user.uid,
                        email: user.email || null,
                        displayName: user.displayName || null,
                        photoURL: user.photoURL || null,
                        createdAt: serverTimestamp(),
                        isActive: true
                    }, { merge: true });
                }
                await updateDoc(userRef, {
                    lastLoginAt: serverTimestamp(),
                    lastLoginClientAt: new Date().toISOString(),
                    lastLoginProvider: 'google',
                    lastLoginEmail: user.email || null,
                    loginCount: increment(1)
                });
            } catch (e) {
                console.warn('upsertUserLogin error:', e);
            }
        }

        // æ¯æ—¥ç­¾åˆ°å¤„ç†å‡½æ•° - æ”¯æŒ Admin æœ¬åœ°ç­¾åˆ° + æ™®é€šç”¨æˆ·é“¾ä¸Šç­¾åˆ°
        window.handleDailyCheckin = async function() {
            try {
                // 1. æ£€æŸ¥é’±åŒ…è¿æ¥
                if (!window.walletManager || !window.walletManager.isConnected) {
                    alert('Please connect your MetaMask wallet to claim the daily check-in bonus.');
                    return;
                }

                // 2. åˆ¤æ–­æ˜¯å¦ä¸º Admin
                const isAdminUser = window.isAdmin && window.isAdmin();
                
                if (isAdminUser) {
                    // ===== Admin ç”¨æˆ· â†’ æ‰§è¡Œå®Œæ•´çš„æœ¬åœ°ç­¾åˆ° + Firebase åŒæ­¥ =====
                    console.log('ğŸ”‘ Admin user detected, executing local check-in');
                    
                    const address = (window.walletManager.walletAddress || '').toLowerCase();
                    
                    if (window.firebaseDb && address) {
                        const { doc, getDoc, setDoc, updateDoc, serverTimestamp } = 
                            await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');

                        const walletRef = doc(window.firebaseDb, 'wallets', address);
                        const snap = await getDoc(walletRef);

                        let lastCheckinAt = null;
                        let remoteTotalCheckins = 0;
                        
                        if (snap.exists()) {
                            const data = snap.data() || {};
                            lastCheckinAt = data.lastCheckinAt || null;
                            remoteTotalCheckins = Number(data.totalCheckins || 0);
                        } else {
                            await setDoc(walletRef, {
                                address: address,
                                createdAt: serverTimestamp(),
                                totalCheckins: 0
                            }, { merge: true });
                        }

                        // åŒæ­¥è¿œç«¯æ—¶é—´æˆ³åˆ°æœ¬åœ°
                        if (lastCheckinAt && typeof lastCheckinAt.toMillis === 'function') {
                            try { 
                                localStorage.setItem('last_checkin_at', String(lastCheckinAt.toMillis())); 
                            } catch (_) {}
                        }

                        // æ‰§è¡Œæœ¬åœ°ç­¾åˆ°
                        const result = window.walletManager.dailyCheckin();
                        if (!result || !result.success) {
                            alert(result?.error || 'ç­¾åˆ°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                            return;
                        }

                        // åŒæ­¥åˆ° Firestore
                        try {
                            await updateDoc(walletRef, {
                                lastCheckinAt: serverTimestamp(),
                                totalCheckins: remoteTotalCheckins + 1,
                                credits: window.walletManager.credits,
                                lastUpdated: serverTimestamp(),
                                lastCheckinType: 'local-admin'
                            });
                        } catch (e) {
                            console.warn('âš ï¸ æ›´æ–° Firestore å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰ï¼š', e);
                        }

                        // åŒæ­¥åˆ° users_by_wallet
                        try {
                            const walletUserRef = doc(window.firebaseDb, 'users_by_wallet', address);
                            await setDoc(walletUserRef, {
                                lastCheckinAt: serverTimestamp(),
                                totalCheckins: remoteTotalCheckins + 1,
                                lastUpdated: serverTimestamp()
                            }, { merge: true });
                        } catch (e) {
                            console.warn('âš ï¸ åŒæ­¥å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰ï¼š', e);
                        }

                        // å¦‚æœæœ‰ Google è´¦æˆ·ï¼ŒåŒæ­¥åˆ° users/<uid>
                        if (window.currentUser && window.currentUser.uid) {
                            try {
                                const userRef = doc(window.firebaseDb, 'users', window.currentUser.uid);
                                await updateDoc(userRef, { lastUpdated: serverTimestamp() });
                            } catch (e) {
                                console.warn('âš ï¸ åŒæ­¥åˆ° users å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰ï¼š', e);
                            }
                        }

                        return;
                    }

                    // Firebase ä¸å¯ç”¨æ—¶çš„é™çº§å¤„ç†
                    const result = window.walletManager.dailyCheckin();
                    Promise.resolve(result).then(r => {
                        if (!r || !r.success) {
                            alert(r?.error || 'Check-in unavailable right now.');
                        }
                    });
                    
                } else {
                    // ===== æ™®é€šç”¨æˆ· â†’ æ‰“å¼€é“¾ä¸Šç­¾åˆ° Modal =====
                    console.log('ğŸ‘¤ Regular user detected, opening on-chain check-in modal');
                    
                    if (typeof window.openOnChainCheckInModal === 'function') {
                        // å…ˆåŠ è½½ç”¨æˆ·çŠ¶æ€
                        if (typeof window.loadUserCheckInStatus === 'function') {
                            await window.loadUserCheckInStatus();
                        }
                        window.openOnChainCheckInModal();
                    } else {
                        console.error('On-chain check-in modal function not found');
                        alert('Check-in feature not available');
                    }
                }
                
            } catch (error) {
                console.error('ç­¾åˆ°å¤±è´¥:', error);
                alert('ç­¾åˆ°å¤±è´¥: ' + error.message);
            }
        };


        // Global helper: clear ALL local data (localStorage and sessionStorage) ONLY.
        // Does not sign out or disconnect wallet. Backward compatible signature.
        // Usage:
        //   window.clearAllLocalData();            // clear only
        //   window.clearAllLocalData(true);        // confirm, then clear
        //   window.clearAllLocalData({ reload: true, confirmFirst: true });
        window.clearAllLocalData = async function(optionsOrConfirm) {
            const opts = (typeof optionsOrConfirm === 'object') ? optionsOrConfirm : { confirmFirst: !!optionsOrConfirm };
            const confirmFirst = !!opts.confirmFirst;
            const reload = !!opts.reload;

            try {
                if (confirmFirst) {
                    const ok = window.confirm('This will remove ALL local data for this site (including chat, workflows, wallet archives). Continue?');
                    if (!ok) return;
                }

                // Clear storages only (no server-side changes)
                try { localStorage.clear(); } catch (_) {}
                try { if (window.sessionStorage) sessionStorage.clear(); } catch (_) {}
                console.log('ğŸ§¹ All local data cleared');

                if (reload) {
                    try { window.location.reload(); } catch (_) {}
                }
            } catch (err) {
                console.error('Error clearing local data:', err);
            }
        };

        // Google ç™»å‡ºå¤„ç†å‡½æ•°
        window.handleGoogleLogout = async function() {
            try {
                if (!firebaseAuth) {
                    alert('Firebase æœªåˆå§‹åŒ–');
                    return;
                }
                
                // ä» firebase-auth å¯¼å…¥ signOutï¼Œè€Œä¸æ˜¯ firestore
                const { signOut } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
                await signOut(firebaseAuth);
                
                console.log('âœ… Google ç™»å‡ºæˆåŠŸ');
                
                // æ›´æ–° UI çŠ¶æ€
                updateUIForSignedOutUser();
                
                // å…³é—­ä¸‹æ‹‰èœå•
                const dropdown = document.getElementById('accountDropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
                
            } catch (error) {
                console.error('âŒ ç™»å‡ºå¤±è´¥:', error);
                alert('ç™»å‡ºå¤±è´¥: ' + error.message);
            }
        };

        // æ˜¾ç¤ºé’±åŒ…é€‰æ‹©æ¨¡æ€æ¡† - ä¿®å¤äº‹ä»¶å†’æ³¡é—®é¢˜ + å»¶è¿Ÿæœºåˆ¶
        window.showWalletSelectionModal = function(event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¤–éƒ¨ç‚¹å‡»å…³é—­
            if (event) {
                event.stopPropagation();
            }
            
            // å…³é—­ä¸‹æ‹‰èœå•
            const dropdown = document.getElementById('accountDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('walletModal');
            modal.style.display = 'flex';
            modal.classList.add('show');
            
            // å»¶è¿Ÿå¯ç”¨å¤–éƒ¨ç‚¹å‡»å…³é—­ï¼Œé¿å…ç«æ€æ¡ä»¶
            setTimeout(() => {
                modal.dataset.readyToClose = 'true';
            }, 100);
        };

        // å…³é—­é’±åŒ…æ¨¡æ€æ¡† - å®Œå…¨å¤åˆ¶è‡ªbenchmark.htmlçš„å·¥ä½œç‰ˆæœ¬
        window.closeWalletModal = function() {
            const modal = document.getElementById('walletModal');
            if (modal) {
                modal.classList.remove('show');
                modal.dataset.readyToClose = 'false'; // é‡ç½®å»¶è¿Ÿæ ‡å¿—
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        };

        // æ£€æŸ¥ Firebase çŠ¶æ€å¹¶æ˜¾ç¤ºé’±åŒ…æ¨¡æ€æ¡†
        window.checkFirebaseAndShowWalletModal = function(event) {
            if (!window.firebaseDb) {
                alert('Firebase åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•...');
                return;
            }
            showWalletSelectionModal(event);
        };

        // æµ‹è¯•å‡½æ•° - æ‰‹åŠ¨åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
        window.testUI = function() {
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const walletSection = document.getElementById('walletSection');
            
            if (googleSignInBtn && walletSection) {
                if (googleSignInBtn.style.display === 'none') {
                    // æ˜¾ç¤º Google ç™»å½•ï¼Œéšè—é’±åŒ…
                    googleSignInBtn.style.display = 'flex';
                    walletSection.style.display = 'none';
                    console.log('âœ… æ˜¾ç¤º Google ç™»å½•ï¼Œéšè—é’±åŒ…åŠŸèƒ½');
                } else {
                    // éšè— Google ç™»å½•ï¼Œæ˜¾ç¤ºé’±åŒ…
                    googleSignInBtn.style.display = 'none';
                    walletSection.style.display = 'block';
                    console.log('âœ… éšè— Google ç™»å½•ï¼Œæ˜¾ç¤ºé’±åŒ…åŠŸèƒ½');
                }
            }
        };

        // æ˜¾ç¤ºç™»å½•æç¤ºå¼¹çª—
        function showLoginPromptModal() {
            const modal = document.getElementById('loginPromptModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('show');
                setTimeout(() => {
                    modal.dataset.readyToClose = 'true';
                }, 100);
            }
        }

        // å…³é—­ç™»å½•æç¤ºå¼¹çª—
        function closeLoginPromptModal() {
            const modal = document.getElementById('loginPromptModal');
            if (modal) {
                modal.classList.remove('show');
                modal.dataset.readyToClose = 'false';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        // ä»æç¤ºå¼¹çª—è§¦å‘ Google ç™»å½•
        function handleGoogleSignInFromPrompt() {
            closeLoginPromptModal();
            handleGoogleSignIn();
        }

        // ä»æç¤ºå¼¹çª—è§¦å‘é’±åŒ…è¿æ¥
        function connectWalletFromPrompt() {
            closeLoginPromptModal();
            showWalletSelectionModal();
        }

        // åˆå§‹åŒ– Firebase å’Œ UI - ä¿®å¤ç‰ˆæœ¬
        function initializeFirebaseAndUI() {
            // Guard to avoid double init
            try { window._firebaseInitStarted = true; } catch (_) {}
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ– Firebase å’Œ UI...');
            
            // ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å­˜åœ¨
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const walletSection = document.getElementById('walletSection');
            const googleSignInStatus = document.getElementById('googleSignInStatus');
            
            if (googleSignInBtn && walletSection && googleSignInStatus) {
                console.log('âœ… æ‰€æœ‰ UI å…ƒç´ å·²æ‰¾åˆ°');
                
                // åˆå§‹åŒ–æ—¶æ˜¾ç¤º Google ç™»å½•å’Œé’±åŒ…åŠŸèƒ½
                googleSignInBtn.style.display = 'flex';
                walletSection.style.display = 'block';
                
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šåˆå§‹æ—¶ç¦ç”¨æŒ‰é’®ï¼Œç­‰ Firebase åŠ è½½å®Œæˆåå†å¯ç”¨
                googleSignInBtn.disabled = true;
                googleSignInBtn.style.opacity = '0.6';
                googleSignInBtn.style.cursor = 'not-allowed';
                
                // åˆå§‹æ—¶éšè— logout æŒ‰é’®
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.style.display = 'none';
                }
                
                console.log('âœ… UI åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾… Firebase åŠ è½½...');
            } else {
                console.error('âŒ æŸäº› UI å…ƒç´ æœªæ‰¾åˆ°');
            }
            
            // åˆå§‹åŒ– Firebase
            initializeFirebase();

            // Optional auto Google login only if user explicitly enabled the setting
            try {
                const autoGoogle = (localStorage.getItem('autoGoogleOnWalletConnect') || 'off') === 'on';
                if (autoGoogle && window.walletManager && window.walletManager.isConnected) {
                    const attemptAutoLogin = () => {
                        if (window.firebaseAuth && !window.firebaseAuth.currentUser && typeof window.handleGoogleSignIn === 'function') {
                            window.handleGoogleSignIn('auto');
                        }
                    };
                    attemptAutoLogin();
                    setTimeout(attemptAutoLogin, 800);
                }
            } catch (_) {}
        }

        // Expose initialization functions globally for console/manual triggers
        window.initializeFirebase = initializeFirebase;
        window.initializeFirebaseAndUI = initializeFirebaseAndUI;

        // å°†é’±åŒ…è¿æ¥ä¿¡æ¯å†™å…¥ Firestoreï¼ˆæ— éœ€å¼ºåˆ¶ Google ç™»å½•ï¼‰
        // è¯´æ˜ï¼š
        // - è‹¥ currentUser å­˜åœ¨ï¼Œåˆ™å†™å…¥ users/<uid> ä¸å…¶å­é›†åˆ wallets/<address>
        // - æ— è®ºæ˜¯å¦ç™»å½•ï¼Œéƒ½ä¼šå†™å…¥é¡¶å±‚ wallets/<address> æ–‡æ¡£ï¼Œä¾¿äºç‹¬ç«‹ç®¡ç†é’±åŒ…
        window.onWalletConnected = async function(address, chainId, networkName) {
            try {
                if (!firebaseDb) throw new Error('Firebase æœªåˆå§‹åŒ–');
                if (!address) throw new Error('address ä¸èƒ½ä¸ºç©º');

                const { doc, setDoc, getDoc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');

                // 1) é¡¶å±‚é›†åˆï¼šwallets/<address>
                const walletRef = doc(firebaseDb, 'wallets', address);
                await setDoc(walletRef, {
                    address: address,
                    chainId: chainId || null,
                    networkName: networkName || null,
                    lastConnectedAt: serverTimestamp(),
                    credits: (window.walletManager && typeof window.walletManager.credits === 'number') ? window.walletManager.credits : 0
                }, { merge: true });

                // 1.5) æ–°å¢ï¼šwallet-only ç”¨æˆ·æ¡£æ¡ˆ users_by_wallet/<address>ï¼ˆä»…æœªç™»å½•æ—¶ï¼‰
                if (!window.currentUser || !window.currentUser.uid) {
                    try {
                        const walletUserRef = doc(firebaseDb, 'users_by_wallet', address.toLowerCase());
                        const stageSnap = await getDoc(walletUserRef);
                        if (stageSnap.exists()) {
                            // ä»…æ›´æ–°è¿æ¥ä¿¡æ¯ï¼Œä¿ç•™é¦–æ¬¡ createdAt
                            await updateDoc(walletUserRef, {
                                lastConnectedAt: serverTimestamp(),
                                chainId: chainId || null,
                                networkName: networkName || null,
                                userType: 'wallet-only'
                            });
                        } else {
                            // é¦–æ¬¡åˆ›å»ºï¼Œå†™å…¥ createdAt
                            await setDoc(walletUserRef, {
                                address: address,
                                createdAt: serverTimestamp(),
                                lastConnectedAt: serverTimestamp(),
                                chainId: chainId || null,
                                networkName: networkName || null,
                                userType: 'wallet-only'
                            }, { merge: true });
                        }
                    } catch (e) {
                        console.warn('å†™å…¥ users_by_wallet å¤±è´¥ï¼ˆå¼€å‘ç¯å¢ƒå¯å¿½ç•¥ï¼‰:', e);
                    }
                }

                // 2) å¦‚å·²ç™»å½• Googleï¼Œåˆ™åŒæ­¥åˆ°ç”¨æˆ·ç©ºé—´
                if (window.currentUser && window.currentUser.uid) {
                    const userRef = doc(firebaseDb, 'users', window.currentUser.uid);
                    const userDocSnap = await getDoc(userRef);
                    if (!userDocSnap.exists()) {
                        await setDoc(userRef, {
                            uid: window.currentUser.uid,
                            email: window.currentUser.email || null,
                            displayName: window.currentUser.displayName || null,
                            createdAt: serverTimestamp(),
                            isActive: true
                        }, { merge: true });
                    }

                    // å°è¯•ä» staging æ–‡æ¡£(users_by_wallet)åˆå¹¶æ•°æ®ï¼ˆä¸å†åˆå¹¶ creditsï¼‰
                    let stagedTotalCheckins = 0;
                    try {
                        const walletUserRef = doc(firebaseDb, 'users_by_wallet', address.toLowerCase());
                        const stageSnap = await getDoc(walletUserRef);
                        if (stageSnap.exists()) {
                            const s = stageSnap.data() || {};
                            stagedTotalCheckins = Number(s.totalCheckins || 0);
                        }
                    } catch (e) {
                        console.warn('è¯»å– users_by_wallet staging å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', e);
                    }

                    await updateDoc(userRef, {
                        primaryWallet: address,
                        primaryChainId: chainId || null,
                        primaryNetwork: networkName || null,
                        walletLinkedAt: serverTimestamp(),
                        walletOnlyProfile: address.toLowerCase()
                    });

                    const userWalletRef = doc(firebaseDb, 'users', window.currentUser.uid, 'wallets', address);
                    await setDoc(userWalletRef, {
                        address: address,
                        chainId: chainId || null,
                        networkName: networkName || null,
                        lastConnectedAt: serverTimestamp(),
                        totalCheckins: stagedTotalCheckins
                    }, { merge: true });

                    // æ ‡è®°é’±åŒ…ä¸ç”¨æˆ·å·²é“¾æ¥
                    try {
                        await updateDoc(walletRef, {
                            linkedUid: window.currentUser.uid,
                            linkedAt: serverTimestamp()
                        });
                    } catch (e) {
                        console.warn('æ ‡è®°é’±åŒ…é“¾æ¥å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', e);
                    }

                    // æ ‡è®° staging æ–‡æ¡£ä¸ºå·²é“¾æ¥ï¼ˆä¿ç•™ä»¥å…¼å®¹å†å²é€»è¾‘ï¼‰
                    try {
                        const walletUserRef = doc(firebaseDb, 'users_by_wallet', address.toLowerCase());
                        await setDoc(walletUserRef, {
                            linked: true,
                            linkedUid: window.currentUser.uid,
                            linkedAt: serverTimestamp()
                        }, { merge: true });
                    } catch (e) {
                        console.warn('æ ‡è®° users_by_wallet å·²é“¾æ¥å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', e);
                    }
                }

                // 3) UI æç¤º
                const info = document.getElementById('walletInfo');
                if (info) {
                    info.style.display = 'block';
                    info.textContent = `Connected Wallet: ${address}`;
                }

                // Log client-side connection time
                console.log('ğŸ•’ Wallet connected at (client):', new Date().toISOString());

                console.log('âœ… é’±åŒ…ä¿¡æ¯å·²å†™å…¥ Firestore', { address, chainId, networkName });
                // æ ‡è®°é’±åŒ…å·²è¿æ¥
                localStorage.setItem('walletConnected', 'true');
            } catch (err) {
                console.error('âŒ å†™å…¥é’±åŒ…ä¿¡æ¯åˆ° Firestore å¤±è´¥:', err);
                alert('ä¿å­˜é’±åŒ…ä¿¡æ¯å¤±è´¥ï¼š' + err.message);
            }
        };

        // â€”â€” å…¨å±€é”™è¯¯ç›‘å¬ï¼Œä¾¿äºæ’æŸ¥åˆå§‹åŒ–è¢«é˜»æ–­çš„é—®é¢˜ â€”â€”
        window.addEventListener('error', function(e) {
            try {
                console.error('ğŸŒ‹ Global error caught:', e.error || e.message, e.filename, e.lineno, e.colno);
            } catch (_) {}
        });
        window.addEventListener('unhandledrejection', function(e) {
            try {
                console.error('ğŸŒ‹ Unhandled promise rejection:', e.reason);
            } catch (_) {}
        });

        // â€”â€” å…œåº•ï¼šå¦‚æœæ­¤æ—¶DOMå·²å‡†å¤‡å¥½ï¼ˆæç«¯æ—¶åºæˆ–ç¼“å­˜å¯¼è‡´ç›‘å¬ä¸¢å¤±ï¼‰ï¼Œç«‹å³åˆå§‹åŒ– â€”â€”
        (function ensureInit() {
            console.log('ğŸ” Inline Firebase script loaded, readyState:', document.readyState);
            if (document.readyState === 'interactive' || document.readyState === 'complete') {
                try {
                    console.log('â© DOM å·²å°±ç»ªï¼Œç«‹å³è°ƒç”¨ initializeFirebaseAndUI()');
                    if (!window._firebaseInitStarted) initializeFirebaseAndUI();
                } catch (err) {
                    console.error('âŒ å…œåº•åˆå§‹åŒ–å¤±è´¥:', err);
                }
            } else {
                console.log('âŒ› ç­‰å¾… DOMContentLoaded');
            }
        })();

        // Ensure initialization once DOM is ready (in case script ran during 'loading')
        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (!window._firebaseInitStarted) {
                    console.log('â© DOMContentLoaded -> initializeFirebaseAndUI()');
                    initializeFirebaseAndUI();
                }
            } catch (err) {
                console.error('âŒ DOMContentLoaded init failed:', err);
            }
        });
        // Extra safety: also try on full window load
        window.addEventListener('load', function() {
            try {
                if (!window._firebaseInitStarted) {
                    console.log('â© window.load -> initializeFirebaseAndUI()');
                    initializeFirebaseAndUI();
                }
            } catch (err) {
                console.error('âŒ window.load init failed:', err);
            }
        });
    </script>

    <!-- é’±åŒ…é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="walletModal" class="wallet-modal">
        <div class="wallet-modal-content">
            <button class="wallet-close-btn" onclick="closeWalletModal()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            
            <div class="wallet-modal-header">
                <h2 class="wallet-modal-title">Log in or sign up</h2>
                <p class="wallet-modal-subtitle">Log in and connect wallet to earn USDC credits</p>
            </div>

            <div class="wallet-options">
                <div class="wallet-option available" onclick="connectSolanaPhantom()">
                    <span class="wallet-icon-wrap">
                        <img src="svg/phantom.svg" alt="Phantom">
                    </span>
                    <div class="wallet-info">
                        <div class="wallet-name">Phantom (Solana Devnet)</div>
                        <div class="wallet-desc">Pay and check in with USDC on Solana Devnet</div>
                    </div>
                </div>

                <div class="wallet-footer">
                    By Intelligence Cubed
                </div>

            </div>
        </div>
    </div>

    <!-- é“¾ä¸Šç­¾åˆ° Modal -->
    <div id="onChainCheckInModal" class="wallet-modal" style="display: none;">
        <div class="wallet-modal-content" style="max-width: 520px;">
            <button class="wallet-close-btn" onclick="closeOnChainCheckInModal()">âœ•</button>
            
            <div class="wallet-modal-header">
                <h2 class="wallet-modal-title">âœ… Check-In on Chain</h2>
                <p class="wallet-modal-subtitle">Complete your daily on-chain check-in to earn USDC credits</p>
            </div>

            <div id="userStatusSection" style="margin: 20px 0; padding: 16px; background: #f0fdf4; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <div>
                        <p style="font-size: 12px; color: #059669; margin-bottom: 4px;">Current Streak</p>
                        <p id="currentStreak" style="font-size: 24px; font-weight: 700; color: #10b981; margin: 0;">0 days</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="font-size: 12px; color: #059669; margin-bottom: 4px;">Total Check-ins</p>
                        <p id="totalCheckIns" style="font-size: 24px; font-weight: 700; color: #10b981; margin: 0;">0</p>
                    </div>
                </div>
                <div style="padding-top: 12px; border-top: 1px solid #d1fae5;">
                    <p style="font-size: 12px; color: #059669; margin-bottom: 4px;">Estimated Reward</p>
                    <p id="nextReward" style="font-size: 20px; font-weight: 700; color: #10b981; margin: 0;">30 credits</p>
                </div>
            </div>

            <div style="margin: 20px 0;">
                <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Network</label>
                <select id="chainSelector" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;" disabled>
                    <option value="SOLANA">Solana (Devnet)</option>
                </select>
            </div>

            <div style="margin: 20px 0; padding: 12px; background: #fef3c7; border-radius: 8px; border: 1px solid #fcd34d;">
                <p style="font-size: 13px; color: #92400e; margin: 0;">â›½ Gas fee: â‰ˆ0.00025 USDC per call</p>
            </div>

            <button id="executeCheckInBtn" onclick="executeOnChainCheckIn()" 
                    style="width: 100%; padding: 16px; background: linear-gradient(135deg, #10b981, #059669); 
                           color: white; border: none; border-radius: 12px; 
                           font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 12px;">
                Check In Now
            </button>

            <div id="checkInLoading" style="display: none; text-align: center; padding: 20px;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #e5e7eb; 
                            border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p id="loadingText" style="margin-top: 12px; color: #6b7280; font-size: 14px;">Processing...</p>
            </div>

            <p style="text-align: center; font-size: 12px; color: #6b7280; margin: 0;">
                Recorded on blockchain for transparency.
            </p>
        </div>
    </div>

    <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    #executeCheckInBtn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    #executeCheckInBtn:disabled { background: #d1d5db; cursor: not-allowed; }
    </style>